// Copyright (2019-2022) Paul Scherrer Institute
// SPDX-License-Identifier: GPL-3.0-or-later

syntax = "proto3";

package JFJochProtoBuf;

enum Compression {
  BSHUF_LZ4 = 0;
  BSHUF_ZSTD = 1;
  NO_COMPRESSION = 2;
}

enum DetectorType {
  JUNGFRAU = 0;
  EIGER = 1;
};

enum DetectorMode {
  CONVERSION = 0;
  RAW = 1;
  PEDESTAL_G0 = 2;
  PEDESTAL_G1 = 3;
  PEDESTAL_G2 = 4;
};

enum FPGAFIFOStatus {
  EMPTY = 0;
  FULL = 1;
  PARTIAL = 2;
}

enum WriterFrameType {
  END_ACQUISITION = 0;
  START_ACQUISITION = 1;
  IMAGE = 2;
}

enum DetectorStatusEnum {
  IDLE = 0;
  ERROR = 1;
  BUSY = 2;
  NO_DETECTOR = 3;
}

// Utilities
message Empty {
}

message UnitCell {
  double a = 1;
  double b = 2;
  double c = 3;
  double alpha = 4;
  double beta = 5;
  double gamma = 6;
}

message Vector {
  double x = 1;
  double y = 2;
  double z = 3;
}

// DiffractionExperiment

message FrameCountSettings {
  int64 images_per_trigger = 1;
  int64 ntrigger = 2;
}

message TimingSettings {
  int64 frame_time_pedestalG1G2_us = 1;
  //   uint64 frame_time_pedestalG2_us = 2; reserved
  int64 frame_time_us = 3;
  int64 count_time_us = 4;
  int64 summation = 5;
  bool time_resolved_mode = 13;
}

message DiffractionGeometrySettings {
  double   beam_x_pxl = 1;
  double   beam_y_pxl = 2;
  double   detector_distance_mm = 3;

  int64 detector_size_x_pxl = 6;
  int64 detector_size_y_pxl = 7;

  int64 gap_x_pxl = 8;
  int64 gap_y_pxl = 9;

  repeated int64 data_stream_modules = 10;
  repeated int64 first_pixel_of_module = 11;
  // Number of modules that are stacked horizontally in a single line
  int64 horizontal_module_stacking = 12;

  Vector scattering_vector = 14;

  double   photon_energy_keV = 16; // Not strictly geometry, but connected
}

message RotationSettings {
  double start_angle_deg = 1;
  double angle_incr_per_image_deg = 2;
  Vector rotation_axis = 3;
}

// Metadata not affecting data acquisition
message BeamlineMetadataSettings {
  string   detector_name = 9;
}

message CompressionSettings {
  Compression algorithm = 1;
  int64 level = 2;
  int64 block_size = 3;
}

message ImageSavingSettings {
  string file_prefix = 1;
  int64 images_per_file = 2;
}

message DetectorSettings {
  bool force_full_speed = 1;
  bool internal_fpga_packet_generator = 2;
  int64 storage_cells = 3;
  int64 storage_cell_start = 4;
  int64 delay_after_trigger_us = 5;
  bool  soft_trigger = 6;
}

message PreviewSettings {
  int64 preview_period_us = 1;
  int64 spot_finding_period_us = 2;
  int64 bkg_estimation_period_us = 3;
}

message PedestalSettings {
  int64 g0_frames = 1;
  int64 g1_frames = 2;
  int64 g2_frames = 3;
}

message ConversionSettings {
  DetectorType type = 5;
  DetectorMode mode = 1;
  bool upside_down = 2;  // Turn modules upside down
  bool mask_module_edges = 3;
  bool mask_chip_edges = 4;
}

message JungfraujochInternalSettings {
  // Settings in this group should be considered fixed from user point of view
  int64 base_ipv4_address = 6;
  int64 base_udp_port = 7;
  string git_sha1 = 8;
  string git_date = 9;
}

message SampleSettings {
  optional UnitCell unit_cell = 2;
  int64 space_group_number = 3;
  int64 run_number = 4;
}

message RadialIntegrationSettings {
  double low_q = 1;
  double high_q = 2;
  double q_spacing = 3;
  double bkg_estimate_low_q = 4;
  double bkg_estimate_high_q = 5;
}

message JungfraujochSettings {
  FrameCountSettings frame_count = 1;
  TimingSettings timing = 2;
  DiffractionGeometrySettings diffraction_geometry = 3;
  BeamlineMetadataSettings beamline_metadata = 4;
  ImageSavingSettings image_saving = 5;
  DetectorSettings detector = 6;
  PreviewSettings preview = 7;
  PedestalSettings pedestal = 8;
  ConversionSettings conv = 9;
  CompressionSettings compr = 10;
  JungfraujochInternalSettings internal = 11;
  SampleSettings sample = 12;
  RadialIntegrationSettings radial_int = 13;
}

// Calibration

message JFPedestal {
  bytes pedestal = 1;
  bytes rms = 2;
  bytes mask = 3;
  int64 time_unix = 4;
  uint64 frames = 5;
}

message JFCalibration {
  uint64 nmodules = 1;
  uint64 nstorage_cells = 2;
  repeated JFPedestal pedestal = 3;
  bytes mask = 4;
}

message JFCalibrationStatistics {
  repeated ModuleStatistics module_statistics = 1;
}

// Receiver

message AcquisitionDeviceStatistics {
  uint64 good_packets = 1;
  uint64 packets_expected_per_module = 2;
  repeated uint64 packets_received_per_module = 3;
  double efficiency = 4;
  uint64 bytes_received = 5;
  uint64 start_timestamp = 6;
  uint64 end_timestamp = 7;
  FPGAStatus fpga_status = 8;
  uint64 nmodules = 9;
  repeated uint64 packet_mask = 10;
  uint64 mask_entries_per_module = 11;
  uint64 packets_expected = 12;
  repeated uint32 timestamp = 13;
  repeated uint32 detector_debug = 14;
  repeated uint64 bunchid = 15;
}

message ReceiverInput {
  JungfraujochSettings jungfraujoch_settings = 1;
  JFCalibration calibration = 2;
  repeated string writer_zmq_address = 3;
}

message ReceiverOutput {
  repeated AcquisitionDeviceStatistics device_statistics = 1;
  uint64 max_receive_delay = 2;
  uint64 compressed_size = 3;
  double compressed_ratio = 4;
  uint64 images_sent = 5;
  uint64 start_time_ms = 6;
  uint64 end_time_ms = 7;
  reserved 8;
  double efficiency = 9;
  uint64 max_image_number_sent = 10;
  reserved 14;

  JungfraujochSettings jungfraujoch_settings = 15;
  optional IndexerOutput indexer_output = 16;
  repeated JFPedestal pedestal_result = 17;
  string master_file_name = 18;
}

message ReceiverNetworkConfig {
  repeated string fpga_mac_addr = 1;
}

message DataFile {
  string filename = 1;
  int64 image_count = 2;
  int64 image0 = 3;
}

// Writer

message WriterInput {
  string zmq_receiver_address = 1;
  repeated DataFile data_files = 2;
  int64 width = 3;
  int64 height = 4;
  int64 images_per_file = 5;
  int64 pixel_depth_bytes = 6;
  bool signed_pxl = 7;
  Compression compression_algorithm = 8;
  int64 compression_block_size = 9;
  string image_units = 10;
  int64 max_spot_count = 11;
}

message WriterOutput {
  int64 nimages = 1;
  float performance_MBs = 2;
  float performance_Hz = 3;
}

message FacilityMetadata {
  string   source_name_short = 10;
  string   source_name = 11;
  string   instrument_name = 12;
  string   instrument_name_short = 13;
}

message ExperimentGeometryMetadata {
  double beam_x_pxl = 1;
  double beam_y_pxl = 2;
  double distance_mm = 3;
  optional Vector scattering_vector = 4; // (if not set use 0,0,1)
}

message DetectorMetadata {
  DetectorType type = 1;
  int64 width_pxl = 2;
  int64 height_pxl = 3;
  int64 pixel_depth_byte = 4;
  bool signed_pxl = 5;
  CompressionSettings compression = 6;
  int64 image_time_us = 7;
  int64 count_time_us = 8;
  int64 overload = 9;
  optional int64 underload = 10;
  double delay_after_trigger_us = 11;
  int64 ntrigger = 12;
  bool time_resolved_mode = 13;
  int64 storage_cell_number = 14;
  double pixel_size_mm = 15;
  double sensor_thickness_um = 16;
  string sensor_material = 17;
}

message BeamMetadata {
  double energy_kev = 1;                      // energy keV
  optional double   transmission = 2;         // 1.0 = full transmission *
  optional double   total_flux_phs = 3;       // in e/s *
  optional double   beam_size_x_um = 4;       // in micron *
  optional double   beam_size_y_um = 5;       // in micron *
}

message SampleMetadata {
  string name = 1;
  optional UnitCell unit_cell = 2;
  optional int64 space_group = 3;
  optional double temperature_K = 4;
  optional RotationSettings omega = 5;
}

message CalibrationMetadataEntry {
  bytes compressed_bshuf_lz4 = 1;
  string name = 2;
  string units = 3;
}

message CalibrationMetadata {
  optional bytes mask_bshuf_lz4 = 1;
  repeated CalibrationMetadataEntry calibration = 2;
}

message WriterMetadataInput {
  FacilityMetadata facility_metadata = 1;
  DetectorMetadata detector_metadata = 2;
  BeamMetadata beam_metadata = 3;
  SampleMetadata sample_metadata = 4;
  CalibrationMetadata calibration_metadata = 5;
  ExperimentGeometryMetadata geometry_metadata = 6;

  int64 image_number = 7;
  int64 images_per_trigger = 8;
  uint64 start_time_ms = 9;
  optional uint64 end_time_ms = 10;
  string metadata_file_name = 11;
  repeated DataFile data_files = 12;
  int64 images_per_file = 13;
}

message WriterSpot {
  float x = 1;
  float y = 2;
  float intensity = 3;
}

message WriterFrame {
  WriterFrameType type = 1;
  optional int64 file_number = 2;
  optional int64 image_number = 3;
  repeated WriterSpot spot_coord = 4;
  optional bytes data = 5;
}

// Detector
message DetectorModuleConfig {
  uint64 udp_dest_port_1 = 1;
  uint64 udp_dest_port_2 = 2;
  string ipv4_src_addr_1 = 3;
  string ipv4_src_addr_2 = 4;
  string ipv4_dest_addr_1 = 5;
  string ipv4_dest_addr_2 = 6;
  string mac_addr_dest_1 = 7;
  string mac_addr_dest_2 = 8;
}

message DetectorConfig {
  repeated DetectorModuleConfig modules = 1;
}

message DetectorInput {
  int64 modules_num = 1;
  DetectorMode mode = 2;
  int64 num_frames = 3;
  int64 num_triggers = 4;
  int64 storage_cell_number = 5;
  int64 storage_cell_start = 6;
  int64 storage_cell_delay = 7;
  int64 period_us = 9;
  int64 count_time_us = 10;
  int64 delay_us = 11;
  bool soft_trigger = 12;
}

message DetectorOutput {

}

message DetectorStatus {
  DetectorStatusEnum status = 1;
  int64 fw_version = 2;
  int64 server_version = 3;
}

message FPGAStatus {
  uint64 packets_ether = 2;
  uint64 packets_udp = 3;
  uint64 packets_jfjoch = 4;
  uint64 packets_icmp = 5;
  bool fpga_idle = 6;
  uint64 hbm_temp = 7;
  uint64 max_hbm_temp = 8;
  uint64 stalls_hbm = 9;
  uint64 stalls_host = 10;
  bool ethernet_rx_aligned = 11;
  bool ethernet_bad_fcs = 12;
  uint32 full_status_register = 13;
  map<string, FPGAFIFOStatus> fifo_status = 14;
  uint64 max_modules = 15;
  uint32 git_sha1 = 16;
  uint32 mailbox_err_reg = 17;
  uint32 mailbox_status_reg = 18;
  bool datamover_mm2s_error = 19;
  bool datamover_s2mm_error = 20;
  bool frame_statistics_alignment_err = 21;
  bool frame_statistics_tlast_err = 22;
  bool frame_statistics_work_req_err = 23;
  uint64 slowest_head = 24;
  bool qsfp_module_present = 25;

  double fpga_temp_degC      = 26;
  double current_edge_12V_A  = 27;
  double voltage_edge_12V_V  = 28;
  double current_edge_3p3V_A = 29;
  double voltage_edge_3p3V_V = 30;

  uint64 pcie_h2c_descriptors = 31;
  uint64 pcie_c2h_descriptors = 32;
  uint64 pcie_h2c_beats       = 33;
  uint64 pcie_c2h_beats       = 34;

  uint64 pcie_h2c_status      = 35;
  uint64 pcie_c2h_status      = 36;
}

message Plot {
  repeated float x = 1;
  repeated float y = 2;
}

message ReceiverStatus {
  double progress = 1;
  repeated FPGAStatus fpga_status = 2;
  bool idle = 3;
  Plot bkg_estimate = 4;
  Plot radial_int_profile = 5;
  Plot spot_count = 6;
  string master_file_name = 7;
}

message DataProcessingSettings {
  double signal_to_noise_threshold = 1;  // STRONG_PIXEL in XDS
  int64 photon_count_threshold = 2;      // Threshold in photon counts
  int64 min_pix_per_spot = 3;            // Minimum pixels per spot
  int64 max_pix_per_spot = 4;            // Maximum pixels per spot
  int64 local_bkg_size = 5;              // NBX/NBY parameter
  optional double high_resolution_limit = 6;
  optional double low_resolution_limit = 7;
}

message PreviewFrame {
  int64 image_number = 1;
  int64 total_images = 2;
  double wavelength_A = 3;
  double beam_center_x = 4;
  double beam_center_y = 5;
  double detector_distance_mm = 6;
  int64 saturation_value = 7;
  string file_prefix = 8;
  int64 width = 9;
  int64 height = 10;
  int64 pixel_depth = 11;
  CompressionSettings compression = 12;
  bytes data = 13;
}

// Indexer
message SpotFinderImageOutput {
  int64 image_number = 1;
  repeated Vector coord = 3;
}

message IndexerStatus {
  Plot indexing_rate = 1;
  int64 images_analyzed = 3;
  int64 images_indexed = 4;
}

message IndexerInput {
  int64 expected_image_number = 1;
  int64 image_stride = 2;
  optional UnitCell unit_cell = 3;
  int64 centering = 4;
  string zmq_recv_pub_addr = 5;
  int64 bin_size = 6;
}

message IndexerImageOutput {
  int64 image_number = 1;
  int64 spot_count = 2;
  bool indexed = 3;
  optional UnitCell unit_cell = 4;
}

message IndexerOutput {
  repeated IndexerImageOutput image_output = 1;
  double ms_per_image = 2;
  int64 indexed_images = 3;
}

// Broker

message ModuleStatistics {
  int64 module_number = 1;
  int64 storage_cell_number = 2;

  double pedestal_g0_mean = 3;
  double pedestal_g1_mean = 4;
  double pedestal_g2_mean = 5;

  double pedestal_rms_g0_mean = 6;
  double pedestal_rms_g1_mean = 7;
  double pedestal_rms_g2_mean = 8;

  uint64 masked_pixels = 9;
}

message Image {
  bytes data = 1;
  int64 width = 2;
  int64 height = 3;
}

message MaskToLoad {
  repeated uint32 mask = 1;
  int32 bit_to_set = 2;
}

message BrokerSetup {
  int64 images_per_trigger = 1;
  optional int64 summation = 2;
  double beam_center_x_pxl = 3;
  double beam_center_y_pxl = 4;
  double detector_distance_mm = 5;
  double photon_energy_kev = 6;
  optional string name_pattern = 7;
  string sample_name = 8;

  optional bool soft_trigger = 14;
  optional int64 ntrigger = 15;

  optional int64 images_per_file = 16;
  optional string compression = 17;

  optional double omega_start_deg = 18;
  optional double omega_increment_deg = 19;

  optional bool time_resolved_mode = 20;

  optional string data_collection_mode = 23;
  optional int64 preview_rate_ms = 27;
  UnitCell unit_cell = 29;
  optional int64 spot_finding_rate_ms = 30;
  optional int64 bkg_estimate_rate_ms = 31;
  optional int64 space_group_number = 33;
  optional int64 detector_delay_after_trigger_us = 35;
}

message BrokerPersistentTimingSettings {
  int64 frame_time_us = 1;
  optional int64 count_time_us = 2;
}

message BrokerPersistentSettings {
  optional bool use_storage_cells = 1;
  optional BrokerPersistentTimingSettings timing = 2;
  optional int64 pedestal_g0_frames = 3;
  optional int64 pedestal_g1_frames = 4;
  optional int64 pedestal_g2_frames = 5;
  optional bool use_internal_packet_generator = 6;
  optional int64 run_number = 7;
}

message MeasurementStatistics {
  uint64 images_collected = 1;
  double collection_efficiency = 2;
  double compression_ratio = 3;
  optional int64 run_number = 4;
  string file_name = 5;
  double writer_performance_MBs = 6;
  uint64 images_written = 7;
}

message BrokerStatus {
  enum State {
    NOT_INITIALIZED = 0;
    IDLE = 1;
    BUSY = 2;
    PEDESTAL = 3;
    DATA_COLLECTION = 4;
    ERROR = 5;
  }
  State current_state = 1;
  optional ReceiverStatus receiver_status = 2;
  optional IndexerStatus indexer_status = 3;
  optional MeasurementStatistics measurement_statistics = 4;

  JFCalibrationStatistics calibration_statistics = 10;
  DetectorStatus detector_state = 11;
}

message BrokerFullStatus {
  ReceiverOutput receiver = 1;
  DetectorOutput detector = 2;
  repeated WriterOutput writer = 3;
  IndexerOutput indexer = 4;
}

service gRPC_JFJochBroker {
  rpc Start (BrokerSetup) returns (Empty) {}
  rpc Stop (Empty)        returns (Empty) {}
  rpc Abort (Empty)       returns (Empty) {}
  rpc Cancel (Empty)      returns (Empty) {}
  rpc Pedestal (Empty)    returns (Empty) {}
  rpc Initialize (Empty)  returns (Empty) {}
  rpc Deactivate (Empty)  returns (Empty) {}
  rpc Setup(BrokerPersistentSettings) returns (Empty) {}
  rpc GetSetup (Empty)       returns (BrokerPersistentSettings) {}
  rpc GetStatus (Empty)      returns (BrokerStatus)     {}
  rpc GetCalibration (Empty) returns (JFCalibration)    {}
  rpc GetFullStatus (Empty)  returns (BrokerFullStatus) {}
  rpc GetDataProcessingSettings (Empty) returns (DataProcessingSettings) {}
  rpc SetDataProcessingSettings (DataProcessingSettings) returns (Empty) {}
  rpc LoadMask (MaskToLoad) returns (Empty) {}
  rpc GetMask (Empty) returns (Image) {}
  rpc GetMaskRawCoord (Empty) returns (Image) {}
  rpc GetPedestalG0 (Empty) returns (Image) {}
  rpc GetPedestalG1 (Empty) returns (Image) {}
  rpc GetPedestalG2 (Empty) returns (Image) {}
  rpc GetPreviewFrame (Empty) returns (PreviewFrame) {}
}

service gRPC_JFJochReceiver {
  rpc Start (ReceiverInput) returns (Empty) {}
  rpc Abort (Empty) returns (Empty) {}
  rpc Cancel (Empty) returns (Empty) {}
  rpc Stop (Empty) returns (ReceiverOutput) {}
  rpc GetStatus (Empty) returns (ReceiverStatus) {}
  rpc SetDataProcessingSettings(DataProcessingSettings) returns (Empty) {}
  rpc GetPreviewFrame (Empty) returns (PreviewFrame) {}
  rpc GetNetworkConfig (Empty) returns (ReceiverNetworkConfig) {}
}

service gRPC_JFJochWriter {
  rpc Start (WriterInput) returns (Empty) {}
  rpc Abort (Empty) returns (Empty) {}
  rpc Stop (Empty) returns (WriterOutput) {}
  rpc WriteMasterFile (WriterMetadataInput) returns (Empty) {}
}

service gRPC_JFJochDetector {
  rpc Start (DetectorInput) returns (Empty) {}
  rpc Stop (Empty) returns (Empty) {}
  rpc Status (Empty) returns (DetectorStatus) {}
  rpc On (DetectorConfig) returns (Empty) {}
  rpc Off (Empty) returns (Empty) {}
  rpc Trigger (Empty) returns (Empty) {}
}

service gRPC_JFJochTrigger {
  rpc Trigger (Empty) returns (Empty) {}
}

service gRPC_JFJochIndexer {
  rpc Start (IndexerInput) returns (Empty) {}
  rpc Stop (Empty) returns (IndexerOutput) {}
  rpc GetStatus (Empty) returns (IndexerStatus) {}
}